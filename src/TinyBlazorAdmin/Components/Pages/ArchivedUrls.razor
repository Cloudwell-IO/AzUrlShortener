@page "/archivedurls"

@using System.Net
@using Cloud5mins.ShortenerTools.Core.Domain
@using Cloud5mins.ShortenerTools.Core.Messages;
@inject UrlManagerClient urlManager
@inject IJSRuntime JSRuntime
@inject IToastService toastService
@inject NavigationManager NavigationManager

@rendermode InteractiveServer

<PageTitle>Cloudwell Go - Archived Urls</PageTitle>

<h1>Archived Urls</h1>
<h3>View and reactivate archived URLs</h3>

<div style="height: 400px; overflow-x:auto; display:flex;">
    <FluentDataGrid Id="grdArchivedUrls" 
                    Items="@filteredUrlList"
                    ResizableColumns=true
                    AllowSorting=true
                    Pagination="@pagination"
                    RowSize="DataGridRowSize.Medium"
                    ShowHover=true>
        <ChildContent>
            <TemplateColumn Width="70px" Sortable="false">
                <FluentButton OnClick="@(async () => await CopyToClipboardAsync(context!.ShortUrl))" IconEnd="@(new Icons.Regular.Size16.Copy())" Title="Copy" />
            </TemplateColumn>
            <TemplateColumn Width="115px" Title="Schedule(s)" Sortable="true" SortBy="@sortBySchedules">
                @(context!.Schedules?.Count ?? 0)
            </TemplateColumn>
            <TemplateColumn Title="Vanity" Width="150px" Sortable="true" SortBy="@sortByVanities" Filtered="!string.IsNullOrWhiteSpace(vanityFilter)"  >
                <ColumnOptions>
                    <div class="search-box">
                        <FluentSearch type="search" Autofocus=true @bind-Value=vanityFilter @oninput="HandleVanityFilter" @bind-Value:after="HandleClearVanityFilter" Placeholder="contains..." />
                    </div>
                </ColumnOptions>
                <ChildContent>
                    <FluentAnchor Href="@context!.ShortUrl" Target="_blank" Appearance="Appearance.Hypertext">@context!.RowKey</FluentAnchor>
                </ChildContent>
            </TemplateColumn>
            <PropertyColumn Title="Title" Property="@(c => c!.Title)" Sortable="true"  Filtered="!string.IsNullOrWhiteSpace(titleFilter)" >
                <ColumnOptions>
                    <div class="search-box">
                        <FluentSearch type="search" Autofocus=true @bind-Value=titleFilter @oninput="HandleTitleFilter" @bind-Value:after="HandleClearTitleFilter" Placeholder="contains..." />
                    </div>
                </ColumnOptions>
            </PropertyColumn>
            <PropertyColumn Title="Url" Property="@(c => c!.Url)" Sortable="true" />
            <TemplateColumn Title="Clicks" Width="110px" Align="Align.End" Sortable="true" SortBy="@sortByClicks">
                <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                    @context.Clicks
                    <FluentButton OnClick="@(() => NavigateToStats(context.RowKey))" IconEnd="@(new Icons.Regular.Size16.ChartMultiple())" />
                </FluentStack>
            </TemplateColumn>
            <PropertyColumn Title="Created" Property="@(c => c!.CreatedDate)" Sortable="true" />
            <TemplateColumn Width="70px" Sortable="false">
                <FluentButton OnClick="@(async () => await ReactivateShortUrl(context))" IconEnd="@(new Icons.Regular.Size16.ArrowUndo())" Title="Reactivate" />
            </TemplateColumn>
        </ChildContent>
        <EmptyContent>
            <FluentIcon Value="@(new Icons.Filled.Size16.Crown())" Color="@Color.Accent" />&nbsp; No archived URLs found.
        </EmptyContent>
    </FluentDataGrid>
</div>
<FluentPaginator State="@pagination" />



@code {

    private ListResponse urls = new ListResponse();

    string vanityFilter = string.Empty;
    string titleFilter = string.Empty;

    IQueryable<ShortUrlEntity>? urlList;
    IQueryable<ShortUrlEntity>? filteredUrlList => urlList?.Where(x => x.RowKey.Contains(vanityFilter, StringComparison.CurrentCultureIgnoreCase) && x.Title.Contains(titleFilter, StringComparison.CurrentCultureIgnoreCase) );

    PaginationState pagination = new PaginationState { ItemsPerPage = 20 };

    GridSort<ShortUrlEntity> sortByClicks = GridSort<ShortUrlEntity>.ByDescending(p => p.Clicks);
    GridSort<ShortUrlEntity> sortBySchedules = GridSort<ShortUrlEntity>.ByDescending(p => p.Schedules.Count);
    GridSort<ShortUrlEntity> sortByVanities = GridSort<ShortUrlEntity>.ByAscending(p => p.RowKey);

    protected override async Task OnInitializedAsync()
    {
        await RefreshGrid();
    }

    private async Task RefreshGrid()
    {
        try
        {
            var allUrls = await urlManager.GetUrls();
            // Filter to show only archived URLs
            urlList = allUrls?.Where(u => u.IsArchived ?? false).AsQueryable();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.ToString());
        }
    }

    private async Task UpdateUIList()
    {
        await RefreshGrid();
        StateHasChanged();
    }

    [Inject] public IJSRuntime JsRuntime { get; set; }
    public async Task CopyToClipboardAsync(string url)
    {
        await JSRuntime.InvokeVoidAsync("clipboardCopy.copyText", url);
    }

    private void NavigateToStats(string vanity){
        NavigationManager.NavigateTo("/Statistics/" + vanity);
    }

    public async Task ReactivateShortUrl(ShortUrlEntity urlEntity)
    {
        var result = await urlManager.UrlReactivate(urlEntity);
        if (result)
        {
            await UpdateUIList();
            toastService.ShowSuccess("Short URL reactivated successfully");
        }
    }

    private void HandleVanityFilter(ChangeEventArgs args)
    {
        if (args.Value is string value)
        {
            vanityFilter = value;
        }
    }

    private void HandleTitleFilter(ChangeEventArgs args)
    {
        if (args.Value is string value)
        {
            titleFilter = value;
        }
    }

    private void HandleClearVanityFilter()
    {
        if (string.IsNullOrWhiteSpace(vanityFilter))
        {
            vanityFilter = string.Empty;
        }
    }

    private void HandleClearTitleFilter()
    {
        if (string.IsNullOrWhiteSpace(titleFilter))
        {
            titleFilter = string.Empty;
        }
    }
}
