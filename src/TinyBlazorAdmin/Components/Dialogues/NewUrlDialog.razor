@using Cloud5mins.ShortenerTools.Core.Messages
@using Cloud5mins.ShortenerTools.TinyBlazorAdmin.Components.Shared
@implements IDialogContentComponent<ShortUrlRequest>

@rendermode InteractiveServer

<FluentDialogHeader ShowDismiss="true">
    <FluentStack VerticalAlignment="VerticalAlignment.Center">
        <FluentIcon Value="@(new Icons.Regular.Size24.WindowApps())" />
        <FluentLabel Typo="Typography.PaneHeader">
            @Dialog!.Instance.Parameters.Title
        </FluentLabel>
    </FluentStack>
</FluentDialogHeader>

<FluentDialogBody>
    <EditForm EditContext="@editContext" FormName="new_note">
        <DataAnnotationsValidator />
		
        <FluentStack Orientation="Orientation.Vertical" VerticalGapGap="10"  Width="100%">

            <div style="width: 100%;">
                <FluentTextField Name="Title" Label="Title" @bind-Value="_shortUrl.Title" Required="false" style="width: 100%;" />
                <FluentValidationMessage For="@(() => _shortUrl.Title)" />
            </div>

            <div style="width: 100%;">
                <FluentTextField Name="Url"
                                 Label="Url"
                                 @bind-Value="_shortUrl.Url"
                                 Placeholder="https://example.com/path"
                                 @oninput="OnUrlInput"
                                 Required="true"
                                 style="width: 100%;" />
                @if (!string.IsNullOrWhiteSpace(_shortUrl.Url) && !IsUrlSchemeValid(_shortUrl.Url))
                {
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="6" VerticalAlignment="VerticalAlignment.Center">
                        <FluentIcon Value="@(new Icons.Regular.Size16.Warning())" Color="Color.Error" />
                        <FluentLabel Color="Color.Error">Must start with http:// or https://</FluentLabel>
                    </FluentStack>
                }
            </div>

            <div style="width: 100%;">
                <FluentTextField Name="Vanity" Label="Vanity" @bind-Value="_shortUrl.Vanity" Required="false" style="width: 100%;" />
                <FluentValidationMessage For="@(() => _shortUrl.Vanity)" />
            </div>

            <div style="width: 100%;">
                <SchedulesComponent Schedules="_shortUrl.Schedules"></SchedulesComponent>
            </div>

        </FluentStack>

	</EditForm>
	
</FluentDialogBody>



<FluentDialogFooter>
    <FluentButton Appearance="Appearance.Accent"
                  Disabled="@(!_shortUrl.Validate())" 
                  OnClick="@SaveAsync">Save</FluentButton>
    <FluentButton Appearance="Appearance.Neutral"
                  OnClick="@CancelAsync">Cancel</FluentButton>
</FluentDialogFooter>


@code {
	[Parameter]
    public ShortUrlRequest Content { get; set; } = default!;

    [CascadingParameter]
    public FluentDialog? Dialog { get; set; } = default!;

	private ShortUrlRequest _shortUrl = new ShortUrlRequest();


    private EditContext? editContext;

    protected override void OnInitialized()
    {
        _shortUrl = Content;
        editContext = new EditContext(_shortUrl);
        editContext.OnFieldChanged += HandleFieldChanged;
    }

    private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        editContext?.Validate();
    }

    private void OnUrlInput(ChangeEventArgs e)
    {
        _shortUrl.Url = e.Value?.ToString() ?? string.Empty;
        editContext?.NotifyFieldChanged(new FieldIdentifier(_shortUrl, nameof(_shortUrl.Url)));
    }

    private static bool IsUrlSchemeValid(string url)
    {
        if (string.IsNullOrWhiteSpace(url)) return false; // caller guards against blank
        if (!Uri.TryCreate(url, UriKind.Absolute, out var uri)) return false;
        return uri.Scheme == Uri.UriSchemeHttp || uri.Scheme == Uri.UriSchemeHttps;
    }
    private void ToggleDialogPrimaryActionButton(bool enable)
    {
        Dialog!.TogglePrimaryActionButton(enable);
    }

	private async Task SaveAsync()
    {
		if (_shortUrl.Validate())
		{
			await Dialog!.CloseAsync(_shortUrl);
		}
    }

    private async Task CancelAsync()
    {
        await Dialog!.CancelAsync();
    }
}
